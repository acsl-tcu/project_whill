function [uOpt,fval,removed] = clustering(obj,pw,pu,px,remove_sample)
% ���񂩂�O��Ă�����̂̓T���v�������菜��
    % �T���v���������邽�߃��T���v�����O���ɑ��₷(���������킹�鏈�����ʂɕK�v�H)
    % �����ȍ~�ł�px��pu,pw�ƃC���f�b�N�X�I�ɑΉ����Ȃ��Ȃ邱�Ƃɒ���
	DT = obj.DT;
	
    k_sigma = 20.0;
    thr = k_sigma;
%     x2 = reshape(x,[1,size(x)]);
%     y2 = reshape(y,[1,size(y)]);
%     th2 = reshape(th,[1,size(th)]);
%     px = [x2;y2;th2];
%     v2 = reshape(v,[1,size(v)]);
%     w2 = reshape(w,[1,size(w)]);
%     pu = [v2;w2];


%     removeF = (pw>=10000);% || px(1,:,:) < tempobj.wall(1,1) || px(1,:,:) > tempobj.wall(1,2) || px(2,:,:) < tempobj.wall(2,1) || px(2,:,:) > tempobj.wall(2,2));
%     pu(:,:,removeF)=[];
%     px(:,:,removeF)=[];
%     pw(removeF)=[];
    %if violate constraint of position then remove
     pu(:,:,remove_sample)=[];
     px(:,:,remove_sample)=[];
     pw(remove_sample)=[];
     
    %if v > 0.7m/s then remove
%      remove_sample = reshape(pu(1,1,:)>0.3,1,length(pu));
%      pu(:,:,remove_sample)=[];
%      px(:,:,remove_sample)=[];
%      pw(remove_sample)=[];
    
    %if omega > 0.7 rad/s then remove

    
    %if kasokudo > 1m/s^2 then remove
%      acc = (obj.v_old - )
     
    % �œK���̎Z�o(���T���v�����O�O�ɕ]���֐��̒l�Ɋ�Â��Ĕ����o���C���͗�Ԃ̋����ɉ����ăN���X�^�����O������@)
    [sortFval,sortIdx]=sort(pw);
    % ���T���v�����O�O�ɕ]���l�̗ǂ����̂�����בւ��C�g�b�v����x%�𔲂��o��
    sortIdxT=sortIdx(1:ceil(0.05*length(pw)));
    pwT = pw(sortIdxT);
    puT = pu(:,:,sortIdxT);
    pxT = px(:,:,sortIdxT);
    
%     figure
%     for i = 1:length(sortIdxT)
%         plot(pxT(1,:,i),pxT(2,:,i));hold on
%     end
%     axis equal
    % 1�Ԃ������̂�1�ڂ̃N���X�^�Ƃ���
    pcT=zeros(1,length(pwT));
    pcT(1) = 1;
    cNum=1;
    
    % 2�Ԗڈȍ~�𑶍݂���N���X�^(2�Ԗڂɂ����Ă�1�ڂ̃N���X�^�̂�)�S�ĂƋ�����r
    % ������臒l�ȉ��Ȃ瓯���N���X�^�ɒǉ��C臒l���傫���Ȃ�V�����N���X�^�ɂ���@�����𔲂��o�����T���v�����J��Ԃ�
    for i=2:length(pwT)
        for j=1:cNum
%             dist(j) = norm(puT(:,:,i) - mean(puT(:,:,pcT==j),3)); % i�Ԗڂ̃T���v����j�Ԗڂ̃N���X�^�̋��������߂�
            dist(j) = sum((pxT(:,:,i) - mean(pxT(:,:,pcT==j),3)).^2,'all');
        end
        [minDist, minIdx]=min(dist);
        if minDist < thr(minIdx)
            pcT(i) = minIdx;
%             thr(minIdx) = minDist;
        else
            cNum=cNum+1;
            pcT(i) = cNum;
            thr(cNum) = k_sigma;
        end
    end
    % �N���X�^���Ƃɏd�ݕt�����ς��Ƃ�C���͗�ƕ]���l���N���X�^���������o�͂���(evalation value -> only the best cluster)
%     if isempty(puT)
%         fval = [];
%     else
        for j=1:cNum
            try
                               
                if sum(pcT==j) == 0
                    error('No samples found for cluster %d', j);
                end
                
                uOpt.u(j).u = mean(puT(:,:,pcT==j),3);
                fval(1) = mean(pwT(pcT==j));
            catch
                fprintf(['ERRO' ...
                    'R in clustering at j=%d:\n'], j);
                fprintf('Error message: %s\n', ME.message);
                fprintf('Error identifier: %s\n', ME.identifier);
                fprintf('puT size: [%s]\n', num2str(size(puT)));
                fprintf('pcT size: [%s]\n', num2str(size(pcT)));
                fprintf('pcT values: [%s]\n', num2str(pcT));
                fprintf('Logical index pcT==j: [%s]\n', num2str(pcT==j));
                fprintf('Number of true values in pcT==j: %d\n', sum(pcT==j));
                
                % Pause to allow inspection
                % This will pause execution and enter debug mode
                
                % Re-throw the error
                rethrow(ME);
            end
        end
        for j = 1:cNum
            uOpt.u(j).x = px(:,1,1);
            for i = 1:length(DT)
                uOpt.u(j).x(1,i+1) = uOpt.u(j).x(1,i) + uOpt.u(j).u(1,i)*cos(uOpt.u(j).x(3,i))*DT(i,1);
                uOpt.u(j).x(2,i+1) = uOpt.u(j).x(2,i) + uOpt.u(j).u(1,i)*sin(uOpt.u(j).x(3,i))*DT(i,1);
                uOpt.u(j).x(3,i+1) = uOpt.u(j).x(3,i) + uOpt.u(j).u(2,i)*DT(i,1);
            end
        end
%     end
    uOpt.cNum = cNum;
    uOpt.pcT = pcT;
    uOpt.puT = puT;
    uOpt.pxT = pxT;
    removed.pu = pu;
    removed.px = px;
    removed.pw = pw;
%     cNum
end